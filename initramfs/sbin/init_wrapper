#!/sbin/busybox sh
#
# init_wrapper
#
#
# 2011 nubecoder
# http://www.nubecoder.com/
#
# Bonsai's init_wrapper script used as a base
# Other bits taken from the following people:
# Tanimn, DRockstar, Rodderik

#functions
SEND_LOG()
{
	log -p i -t init:init_wrapper "init_wrapper : $1"
}

#main
SEND_LOG "Start"

SEND_LOG "Remount as RW"
/sbin/busybox mount -o remount,rw /
/sbin/busybox mount -o remount,rw /system

SEND_LOG "Installing busybox to /bin"
/sbin/busybox mkdir /bin
/sbin/busybox --install -s /bin
/sbin/busybox rm -rf /system/xbin/busybox
/sbin/busybox ln -s /sbin/busybox /system/xbin/busybox

SEND_LOG "Sync filesystem"
sync

SEND_LOG "Remove unneccessary files"
for FOLDER in res ; do
	SEND_LOG "  rm -rf $FOLDER"
	rm -rf /$FOLDER
done

SEND_LOG "Fixing permissions and ownership"
SEND_LOG "chmod 0755 /sbin/*"
chmod 0755 /sbin/*
for FILE in default.prop init init.sh ; do
	SEND_LOG "  chown root.system /$FILE"
	chown root.system /$FILE
done
for FOLDER in lib lib/modules modules sbin ; do
	SEND_LOG "  chown root.system /$FOLDER"
	chown root.system /$FOLDER
	SEND_LOG "  chown root.system /$FOLDER/*"
	chown root.system /$FOLDER/*
done

SEND_LOG "Ensuring su is properly installed"
SU_CHECK=$(which su)
if [ ! -f "$SU_CHECK" ]; then
	SEND_LOG "  Installing su to /system/bin/su"
	cp /su/su /system/bin/su
	chown 0.0 /system/bin/su
	chmod 6755 /system/bin/su
	rm -f /system/xbin/su
	rm -f /system/bin/jk-su
	SEND_LOG "  Symlinking su in /system/xbin/su"
	ln -s /system/bin/su /system/xbin/su
fi
rm -rf /su

SEND_LOG "Ensuring user files are set up properly"
if [ ! -f "/system/etc/passwd" ]; then
	SEND_LOG "  Setting up /etc/passwd"
	echo "root::0:0:root:/:/sbin/sh" > /system/etc/passwd
	echo "shell::2000:2000:shell:/data/local:/sbin/sh" >> /system/etc/passwd
fi
chown root.root /system/etc/passwd
chmod 0644 /system/etc/passwd
if [ ! -f "/system/etc/group" ]; then
	SEND_LOG "  Setting up /etc/group"
	echo "root::0:" > /system/etc/group
	echo "shell::2000:" >> /system/etc/group
fi
chown root.root /system/etc/group
chmod 0644 /system/etc/group

SEND_LOG "Ensuring the Superuser app is installed"
if [ ! $(find /system/app -iname "superuser.apk") ] &&\
		[ ! $(find /data/app -iname "superuser.apk") ] &&\
		[ ! $(find /data/app -iname "com.noshufou.android.su*") ] ; then
	SEND_LOG "  Installing superuser.apk to /data/app/com.noshufou.android.su-1.apk"
	cp /sbin/superuser.apk /data/app/com.noshufou.android.su-1.apk
	chown system.system /data/app/com.noshufou.android.su-1.apk
	chmod 0644 /data/app/com.noshufou.android.su-1.apk
	SEND_LOG "Ensuring old Superuser app data is removed"
	SU_APK_TEST=$(find /data/data/ -iname "com.noshufou.android.su")
	for SU_APK_FOLDER in $SU_APK_TEST ; do
		SEND_LOG "  Removing data folder: $SU_APK_FOLDER"
		rm -rf "$SU_APK_FOLDER"
	done
	SU_APK_TEST=$(find /data/dalvik-cache/ -iname "*superuser.apk*.dex")
	for SU_APK_FILE in $SU_APK_TEST ; do
		SEND_LOG "  Removing data file: $SU_APK_FILE"
		rm -f "$SU_APK_FILE"
	done
	SU_APK_TEST=$(find /data/dalvik-cache/ -iname "*com.noshufou.android.su*.dex")
	for SU_APK_FILE in $SU_APK_TEST ; do
		SEND_LOG "  Removing data file: $SU_APK_FILE"
		rm -f "$SU_APK_FILE"
	done
fi
rm -f /sbin/superuser.apk

SEND_LOG "Ensuring bash is installed"
if [ ! -f "/system/bin/bash" ]; then
	SEND_LOG "  Installing Bash to /system/bin/"
	cp /sbin/bash /system/bin/bash
fi
chmod 0755 /system/bin/bash
rm -f /sbin/bash

SEND_LOG "Checking for bash as default shell"
BASH_FOUND=$(ls -l "/system/bin/sh" | grep "system/bin/bash")
if [ ! "$BASH_FOUND" = "" ] && [ -f "/system/bin/bash" ]; then
	SEND_LOG "  Allowing bash as default shell"
	rm -f /bin/sh
	rm -f /sbin/sh
	ln -s /bin/sh /system/bin/sh
	ln -s /sbin/sh /system/bin/sh
fi

SEND_LOG "Preventing certain malware apps (DroidDream)"
. > /system/bin/profile
chmod 0400 /system/bin/profile

SEND_LOG "Ensuring busybox DNS is set up properly"
if [ ! -f "/system/etc/resolv.conf" ]; then
	SEND_LOG "  Setting Busybox DNS"
	echo "nameserver 8.8.8.8" >> /system/etc/resolv.conf
	echo "nameserver 8.8.4.4" >> /system/etc/resolv.conf
fi

SEND_LOG "Ensuring KB timer_delay is set up properly"
if [ ! -f "/data/local/timer_delay" ]; then
	SEND_LOG "  Setting KB timer_delay to 5"
	echo 5 > /data/local/timer_delay
fi
cat /data/local/timer_delay > /sys/devices/platform/s3c-keypad/timer_delay

SEND_LOG "Sync filesystem"
sync

SEND_LOG "Remove self"
rm -f "/sbin/init_wrapper"

SEND_LOG "End"

